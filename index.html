<!-- views/index.ejs -->
<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>contentNegociation</title>
    <meta descr="">
	<script src="http://code.jquery.com/jquery-1.7.1.js" type="text/javascript"></script>
   
</head>
<body>
		<button type="button" id="generate">Generate</button>
		<button type="button" id="jsonbtn">JSON</button>
        <button type="button" id="csvbtn">CSV</button>
		<button type="button" id="savebtn">Save</button>
		
		<button type="button" id="appelcsv">AppelAPICSV</button>
		<button type="button" id="appeljson">AppelAPIJSON</button>

    <div id="response">
        Joke : <div id=datajoke></div>
		Category : <div id=datacategory></div>
		Emoji : <div id=dataemoji></div>
    </div>
	<div id="response2">data response API : <div id=datacontent><%= JSON.stringify(data.json)%></div> </div>

</body>
</html>

<script>
jsonbtn = document.getElementById("jsonbtn")
csvbtn = document.getElementById("csvbtn")
savebtn = document.getElementById("savebtn")

var test;
var likedjoke ="";
var jokes = "";
//const { Parser } = require('json2csv');
const fields = ['blague', 'categorie', 'emoji'];


function fetchehpadjson(route)
{
	if (jokes!="")
	{	jokes = jokes+"]"
		console.log(JSON.stringify(jokes));
		
		var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jokes);
		var dlAnchorElem = document.createElement('a');
		dlAnchorElem.setAttribute("href",     dataStr     );
		dlAnchorElem.setAttribute("download", "scene.json");
		dlAnchorElem.click();
		jokes = ""
	}
}

function generateJoke(route)
{
    fetch(route, 
                {
                    method: 'GET',
                    headers: { 'accept' : 'application/json'}
                }
            ).then(function(response){
                response.json().then(function(data)
                {
					var joke = JSON.parse(JSON.stringify(data))
                    document.getElementById("datajoke").innerHTML = joke.blague;
					document.getElementById("datacategory").innerHTML = joke.categorie;
					document.getElementById("dataemoji").innerHTML = joke.emoji;
					likedjoke= joke;
                })
            })
}

function generateJokecsv(route)
{
    fetch(route, 
                {
                    method: 'GET',
                    headers: { 'accept' : 'application/csv'}
                }
            ).then(function(response){
                  response.blob().then(function(datablob)
                {
                    datablob.name = 'newfile.csv'
                    anchor = document.createElement('a')
                    anchor.download = datablob.name
                    anchor.href = window.URL.createObjectURL(datablob)
                    anchor.dataset.downloadurl = ['application/csv', anchor.download, anchor.href].join(':')
                    anchor.click()
                })
			})
}


function generateJokejson(route)
{
    fetch(route, 
                {
                    method: 'GET',
                    headers: { 'accept' : 'application/json'}
                }
            ).then(function(response){
                response.json().then(function(data)
                {
					document.getElementById("datacontent").innerHTML = JSON.stringify(data)
                })
            })
}

function save(){
console.log("joke",likedjoke);
	if (jokes=="")
	{jokes= '['+JSON.stringify(likedjoke)}
	else
	{jokes = jokes+','+JSON.stringify(likedjoke)}
}

function fetchehpadcsv(route)
{

	if (jokes != "")
	{
		jokes = jokes+"]"
		
		const items = JSON.parse(jokes)
		const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
		const header = Object.keys(items[0])
		let csv = items.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','))
		csv.unshift(header.join(','))
		csv = csv.join('\r\n')
		var dlAnchorElem = document.createElement('a');
		var dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
		dlAnchorElem.setAttribute("href",     dataStr     );
		dlAnchorElem.setAttribute("download", "scene.csv");
		dlAnchorElem.click();
		jokes = "";
	}
	
	
}
//Simulation d'appel de l'API
appeljson.onclick = function(){
	generateJokejson(`/joke`)
}

appelcsv.onclick= function(){
	generateJokecsv(`/joke`)
}
//////////////////////////////////
savebtn.onclick = function(){
	save()
}

generate.onclick = function()
{
	console.log("clicked on generate")
	generateJoke(`/`)
}

jsonbtn.onclick = function()
{
    console.log("clicked on json")
    fetchehpadjson(`/blague`)
}

csvbtn.onclick = function()
{
    console.log("clicked on csv")
    fetchehpadcsv(`/blague`)   
}

</script>