<!-- views/index.ejs -->
<!doctype html>
<html lang="fr">
<head>
    <title>contentNegociation</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="http://code.jquery.com/jquery-1.7.1.js" type="text/javascript"></script>
	  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
   
</head>
<style>
body {font-family: "Lato", sans-serif}
.mySlides {display: none}
</style>
<body>

<!-- Page content -->
<div class="w3-content" style="max-width:2000px;">

  <!-- The Band Section -->
  <div class="w3-container w3-content w3-center w3-padding-64" style="max-width:800px" id="band">
    <h2 class="w3-wide">OpendataMIASHS</h2>
    <p class="w3-opacity"><i>Générez vos propres blagues</i></p>
    <p class="w3-justify">Cette API renvoie une blague ainsi que son analyse sentimentale (Positif/Neutre/Négatif). Et puis, simuler la réaction sur une telle blague en observant la réponse du ChatBot. Elle se base sur trois autres API: une générant la blague, une autre analysant les sentiments d'une chaine de caractères et un ChatBot.
<br />
On passe donc le résultat de la première dans les deux autres. Puis, nous les restituons.
<br />
Le serveur utilise la technologie NodeJS avec le framework Express.js ainsi que les dépendances se trouvant dans le fichier package.json.</p>
    <div class="w3-row w3-padding-32">
      <div class="w3-third">
        <p>Basique</p>
		
		<button type="button" id="generate" class="btn btn-primary">Generate</button>
		<button type="button" id="jsonbtn" class="btn btn-success">JSON</button>
        <button type="button" id="csvbtn" class="btn btn-info">CSV</button>
		<button type="button" id="savebtn" class="btn btn-warning">Save</button>
		
      </div>
      <div class="w3-third">
        <p>Négociation de contenu</p>
		<button type="button" id="appelcsv" class="btn btn-primary">AppelAPICSV</button>
		<button type="button" id="appeljson" class="btn btn-success">AppelAPIJSON</button>
      </div>
      <div class="w3-third">
        <p>Reaction du ChatBot</p>
		<button type="button" id="checkreactionbtn" class="btn btn-primary">CheckReaction</button>
      </div>
    </div>
	
    <div class="w3-row w3-padding-32">
      <div class="w3-third">
        <p>Génération Des Blagues de type: Dark</p>
		<button type="button" id="darkjokesCSV" class="btn btn-primary">AppelAPIDarkCSV</button>
		<button type="button" id="darkjokesJSON" class="btn btn-success">AppelAPIDarkJSON</button>
		
      </div>
      <div class="w3-third">
        <p>Génération Des Blagues de type: Programming</p>
		<button type="button" id="programmingjokesCSV" class="btn btn-primary">AppelAPIProgrammingCSV</button>
		<button type="button" id="programmingjokesJSON" class="btn btn-success">AppelAPIProgrammingJSON</button>
		
      </div>
      <div class="w3-third">
        <p>Génération Des Blagues de type: Miscellaneous</p>
		<button type="button" id="miscellaneousjokesCSV" class="btn btn-primary">AppelAPIMiscellaneousCSV</button>
		<button type="button" id="miscellaneousjokesJSON" class="btn btn-success">AppelAPIMiscellaneousJSON</button>
		
      </div>
    </div>
	

  </div>
  
  <div class="w3-container w3-content w3-padding-64 bg-primary" style="max-width:800px"> 
    <h2 class="w3-wide w3-center">Réponses</h2>
	<br/>
  <div id="response">
        <h3>Joke : </h3><div id=datajoke></div>
		<h3>Category : </h3><div id=datacategory></div>
		<h3>Emoji : </h3><div id=dataemoji></div>
  </div>
  <div id="response2"><h3>data response API :</h3><div id=datacontent><%= JSON.stringify(data.json)%></div> 
  </div>
  <div id="response3">
        <h3>BotResponse :</h3> <div id=botresponse></div>
  <br />
  </div>
  </div>
</body>


  <!-- The Contact Section -->
  <div class="w3-container w3-content w3-padding-64" style="max-width:800px" id="contact">
    <h2 class="w3-wide w3-center">CONTACT</h2>
    <p class="w3-opacity w3-center"><i>Fan? Drop a note!</i></p>
    <div class="w3-row w3-padding-32">
      <div class="w3-col m6 w3-large w3-margin-bottom">
        <i class="fa fa-map-marker" style="width:30px"></i>34000 Montpellier<br>
        <i class="fa fa-phone" style="width:30px"></i> Phone: +0033 0611223344<br>
        <i class="fa fa-envelope" style="width:30px"> </i> Email: opendata@mail.com<br>
      </div>
      <div class="w3-col m6">
        <form action="/action_page.php" target="_blank">
          <div class="w3-row-padding" style="margin:0 -16px 8px -16px">
            <div class="w3-half">
              <input class="w3-input w3-border" type="text" placeholder="Name" required name="Name">
            </div>
            <div class="w3-half">
              <input class="w3-input w3-border" type="text" placeholder="Email" required name="Email">
            </div>
          </div>
          <input class="w3-input w3-border" type="text" placeholder="Message" required name="Message">
          <button class="w3-button w3-black w3-section w3-right" type="">SEND</button>
        </form>
      </div>
    </div>
  </div>
  
<!-- End Page Content -->
</div>
<!-- Footer -->
<footer class="w3-container w3-padding-64 w3-center w3-opacity w3-light-grey w3-xlarge">
  <i class="fa fa-facebook-official w3-hover-opacity"></i>
  <i class="fa fa-instagram w3-hover-opacity"></i>
  <i class="fa fa-snapchat w3-hover-opacity"></i>
  <i class="fa fa-pinterest-p w3-hover-opacity"></i>
  <i class="fa fa-twitter w3-hover-opacity"></i>
  <i class="fa fa-linkedin w3-hover-opacity"></i>
  <p class="w3-medium">Powered by <a href="https://github.com/Gouacide/opendataMIASHS/tree/Heroku" target="_blank">Gouacide</a></p>
</footer>

<script>

// When the user clicks anywhere outside of the modal, close it
var modal = document.getElementById('ticketModal');
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
</script>


</html>

<script>
jsonbtn = document.getElementById("jsonbtn")
csvbtn = document.getElementById("csvbtn")
savebtn = document.getElementById("savebtn")
checkreactionbtn = document.getElementById("checkreactionbtn")

var test;
var likedjoke ="";
var jokes = "";
//const { Parser } = require('json2csv');
const fields = ['blague', 'categorie', 'emoji'];


function fetchehpadjson(route)
{
	if (jokes!="")
	{	jokes = jokes+"]"
		console.log(JSON.stringify(jokes));
		
		var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jokes);
		var dlAnchorElem = document.createElement('a');
		dlAnchorElem.setAttribute("href",     dataStr     );
		dlAnchorElem.setAttribute("download", "scene.json");
		dlAnchorElem.click();
		jokes = ""
	}
}

function generateJoke(route)
{
    fetch(route, 
                {
                    method: 'GET',
                    headers: { 'accept' : 'application/json'}
                }
            ).then(function(response){
                response.json().then(function(data)
                {
					var joke = JSON.parse(JSON.stringify(data))
                    document.getElementById("datajoke").innerHTML = joke.blague;
					document.getElementById("datacategory").innerHTML = joke.categorie;
					var emoj = "";
					if(joke.emoji.includes(" :) ")){
						emoj = emoj + "&#x1F600; ";
					}
					if(joke.emoji.includes(" :| ")){
						emoj = emoj + "&#x1F914; ";
					}
					if(joke.emoji.includes(" :( ")){
						emoj = emoj + "&#x1F61F; ";
					}
					document.getElementById("dataemoji").innerHTML = emoj;
					likedjoke= joke;
                })
            })
}

function generateJokecsv(route)
{
    fetch(route, 
                {
                    method: 'GET',
                    headers: { 'accept' : 'application/csv'}
                }
            ).then(function(response){
                  response.blob().then(function(datablob)
                {
                    datablob.name = 'newfile.csv'
                    anchor = document.createElement('a')
                    anchor.download = datablob.name
                    anchor.href = window.URL.createObjectURL(datablob)
                    anchor.dataset.downloadurl = ['application/csv', anchor.download, anchor.href].join(':')
                    anchor.click()
                })
			})
}


function generateJokejson(route)
{
    fetch(route, 
                {
                    method: 'GET',
                    headers: { 'accept' : 'application/json'}
                }
            ).then(function(response){
                response.json().then(function(data)
                {
					document.getElementById("datacontent").innerHTML = JSON.stringify(data)
                })
            })
}

function save(){
console.log("joke",likedjoke);
	if (jokes=="")
	{jokes= '['+JSON.stringify(likedjoke)}
	else
	{jokes = jokes+','+JSON.stringify(likedjoke)}
}

function fetchehpadcsv(route)
{

	if (jokes != "")
	{
		jokes = jokes+"]"
		
		const items = JSON.parse(jokes)
		const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
		const header = Object.keys(items[0])
		let csv = items.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','))
		csv.unshift(header.join(','))
		csv = csv.join('\r\n')
		var dlAnchorElem = document.createElement('a');
		var dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
		dlAnchorElem.setAttribute("href",     dataStr     );
		dlAnchorElem.setAttribute("download", "scene.csv");
		dlAnchorElem.click();
		jokes = "";
	}
	
	
}

//*********************************************************************************
function checkreaction(route)
{
    fetch(route, 
			   {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(likedjoke)
			}
            ).then(function(response){
                response.json().then(function(data)
                {
					var answer  = JSON.parse(JSON.stringify(data))
					console.log(answer.cnt);
                    document.getElementById("botresponse").innerHTML = answer.cnt;
					
                })
            })
}

//*********************************************************************************

//Simulation d'appel de l'API
//*********************************************
darkjokesJSON.onclick = function(){
	generateJokejson(`/joke/Dark`)
}
darkjokesCSV.onclick = function(){
	generateJokecsv(`/joke/Dark`)
}



programmingjokesJSON.onclick = function(){
	generateJokejson(`/joke/Programming`)
}
programmingjokesCSV.onclick = function(){
	generateJokecsv(`/joke/Programming`)
}



miscellaneousjokesJSON.onclick = function(){
	generateJokejson(`/joke/Miscellaneous`)
}
miscellaneousjokesCSV.onclick = function(){
	generateJokecsv(`/joke/Miscellaneous`)
}


//*********************************************
appeljson.onclick = function(){
	generateJokejson(`/joke`)
}

appelcsv.onclick= function(){
	generateJokecsv(`/joke`)
}
//////////////////////////////////
savebtn.onclick = function(){
	save()
}

generate.onclick = function()
{
	console.log("clicked on generate")
	generateJoke(`/`)
}

jsonbtn.onclick = function()
{
    console.log("clicked on json")
    fetchehpadjson(`/blague`)
}

csvbtn.onclick = function()
{
    console.log("clicked on csv")
    fetchehpadcsv(`/blague`)   
}


checkreactionbtn.onclick = function()
{
    console.log("clicked to check reaction")
    checkreaction(`/checkreaction`)   
}


</script>